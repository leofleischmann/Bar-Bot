<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drinks Übersicht</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 20px;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        header h1 {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            margin: 0;
            text-align: center;
            width: 100%;
        }

        #esp-status {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 14px;
            font-weight: bold;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status .indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
        }

        .status.connected .indicator {
            background-color: green;
        }

        .status.disconnected .indicator {
            background-color: red;
        }

        @media (max-width: 600px) {
            .header-container {
                flex-direction: column;
                align-items: center;
            }

            #esp-status {
                justify-content: center;
                margin-top: 10px;
                text-align: center;
            }

            header h1 {
                position: static;
                transform: none;
                font-size: 24px;
                margin: 0 0 10px 0;
                text-align: center;
            }
        }

        main {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        nav {
            text-align: center;
            margin-bottom: 30px;
        }

        nav button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        nav button:hover {
            background-color: #0056b3;
        }

        .config-section {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 40px;
        }

        .config-section h2 {
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .config-section p {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .grid-item {
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            background-color: #fff;
        }

        .grid-item.valid {
            border-left: 5px solid #28a745;
        }

        .grid-item.invalid {
            border-left: 5px solid #dc3545;
        }

        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .grid-item .info-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            cursor: pointer;
            color: #007bff;
            background: #f1f1f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        /* Neue Konfigurations-Icon oben rechts */
        .grid-item .config-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            cursor: pointer;
            color: #007bff;
            background: #f1f1f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .grid-item .letter {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
        }

        .grid-item .name {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .start-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .start-button:hover {
            background-color: #0056b3;
        }

        footer {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #666;
            padding-bottom: 20px;
        }

        #progress-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #progress-text {
            margin-bottom: 10px;
            font-weight: bold;
        }

        #progress-container div[style*="width: 100%;"] {
            background-color: #ccc;
            border-radius: 10px;
            margin: 0 auto;
            height: 20px;
            max-width: 500px;
        }

        #progress-bar {
            width: 0%;
            background-color: #28a745;
            height: 20px;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        form {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: white;
            max-width: 500px;
            margin: 20px auto;
            display: none;
        }

        form label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        form input, form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        form button {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        form button:hover {
            background-color: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 15px;
        }

        .modal ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        .modal ul li {
            margin-bottom: 12px;
            display:flex;
            flex-direction:column;
            gap:5px;
        }

        .modal ul li label {
            font-weight:bold;
        }

        .modal .close-button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            margin-top:10px;
        }

        .modal .close-button:hover {
            background-color: #c82333;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .snackbar {
            visibility: hidden;
            min-width: 300px;
            max-width: 90%;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px 20px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
        }

        .snackbar.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .snackbar.error {
            background-color: #f44336;
        }

        .snackbar.success {
            background-color: #4caf50;
        }

        .toggle-manual {
            margin-top: 30px;
            text-align:center;
        }

        .toggle-manual button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 30px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display:inline-flex;
            align-items:center;
            gap:5px;
        }

        .toggle-manual button:hover {
            background-color: #0056b3;
        }

        /* Modal für Custom Konfiguration */
        #custom-config-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            width: 300px;
        }

        #custom-config-modal h3 {
            margin-bottom: 15px;
            text-align:center;
        }

        #custom-config-modal ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #custom-config-modal ul li {
            margin-bottom: 15px;
        }

        #custom-config-modal ul li label {
            font-weight: bold;
            display:block;
            margin-bottom:5px;
        }

        #custom-config-modal ul li input[type=range] {
            width: 100%;
        }

        #custom-config-modal-buttons {
            display:flex;
            justify-content:space-between;
            gap:10px;
            margin-top:20px;
        }

        #custom-config-modal-buttons button {
            flex:1;
            border:none;
            border-radius:5px;
            padding:8px;
            cursor:pointer;
            font-size:14px;
            text-align:center;
        }

        #custom-config-modal-cancel {
            background-color:#dc3545;
            color:white;
        }

        #custom-config-modal-cancel:hover {
            background-color:#c82333;
        }

        #custom-config-modal-start {
            background-color:#28a745;
            color:white;
        }

        #custom-config-modal-start:hover {
            background-color:#218838;
        }

        #custom-config-overlay {
            display: none;
            position: fixed;
            top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.5);
            z-index:1999;
        }

        .config-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            cursor: pointer;
            color: #007bff;
            background: #f1f1f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display:flex;
            justify-content:center;
            align-items:center;
        }
    </style>
<script>

let espConnected = false;
let progressInterval;
let currentCustomIngredients = []; // Für die momentan angezeigte config

function updateESPStatus() {
    fetch("/esp_status")
        .then(response => response.json())
        .then(data => {
            espConnected = data.connected;
            const statusElement = document.getElementById("esp-status");

            if (data.connected) {
                statusElement.innerHTML = `
                    <span class="status connected">
                        <span class="indicator"></span> ESP verbunden
                    </span>`;
            } else {
                statusElement.innerHTML = `
                    <span class="status disconnected">
                        <span class="indicator"></span> ESP nicht verbunden
                    </span>`;
            }
        })
        .catch(error => {
            console.error("Fehler beim Abrufen des ESP-Status:", error);
            espConnected = false;
            const statusElement = document.getElementById("esp-status");
            statusElement.innerHTML = `
                <span class="status disconnected">
                    <span class="indicator"></span> ESP nicht verbunden
                </span>`;
        });
}

setInterval(updateESPStatus, 5000);
updateESPStatus();

function showSnackbar(message, type = "success") {
    const snackbar = document.getElementById("snackbar");
    snackbar.textContent = message;
    snackbar.className = "snackbar";
    snackbar.classList.add(type);
    snackbar.classList.add("show");
    setTimeout(() => {
        snackbar.classList.remove("show");
    }, 3000);
}

async function startRecipe(recipeName) {
    if (!espConnected) {
        showSnackbar("ESP ist nicht verbunden. Bitte überprüfen Sie die Verbindung.", "error");
        return;
    }

    try {
        const response = await fetch("/run_recipe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ recipe: recipeName }),
        });
        const result = await response.json();

        if (response.ok) {
            showSnackbar(`Rezept "${recipeName}" erfolgreich gestartet!`, "success");
            startProgressTracking();
        } else {
            throw new Error(result.message || "Fehler beim Starten des Rezepts");
        }
    } catch (error) {
        showSnackbar(error.message, "error");
    }
}

function showInvalidReasons(recipeId) {
    const reasonsDiv = document.getElementById(`reasons-${recipeId}`);
    if (!reasonsDiv) {
        showSnackbar("Es gibt keine spezifischen Gründe für die Ungültigkeit dieses Rezepts.", "error");
        return;
    }

    const reasons = reasonsDiv.textContent.trim();
    if (reasons) {
        alert("Fehlende Drinks:\n" + reasons);
    } else {
        showSnackbar("Es gibt keine spezifischen Gründe für die Ungültigkeit dieses Rezepts.", "error");
    }
}

async function sendManualCommand() {
    const commandType = document.getElementById("manualCommandType").value;
    const value = parseInt(document.getElementById("manualValue").value);

    if (commandType === "pump") {
        const pumpNumber = parseInt(document.getElementById("pumpNumber").value);
        if (isNaN(value) || isNaN(pumpNumber)) {
            showSnackbar("Bitte geben Sie eine gültige Pumpennummer und Dauer ein.", "error");
            return;
        }

        try {
            const response = await fetch("/send_command", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ type: commandType, pump: pumpNumber, value: value })
            });

            const result = await response.json();
            if (response.ok) {
                showSnackbar(result.message, "success");
            } else {
                throw new Error(result.message || "Fehler beim Senden des Befehls.");
            }
        } catch (error) {
            console.error("Fehler beim Senden des Pumpenbefehls:", error);
            showSnackbar("Es gab ein Problem beim Senden des Befehls.", "error");
        }
    } else {
        if (!commandType || isNaN(value)) {
            showSnackbar("Bitte geben Sie einen gültigen Befehl und Wert ein.", "error");
            return;
        }

        try {
            const response = await fetch("/send_command", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ type: commandType, value: value })
            });

            const result = await response.json();
            if (response.ok) {
                showSnackbar(result.message, "success");
            } else {
                throw new Error(result.message || "Fehler beim Senden des Befehls.");
            }
        } catch (error) {
            console.error("Fehler beim Senden des Befehls:", error);
            showSnackbar("Es gab ein Problem beim Senden des Befehls.", "error");
        }
    }
}

function toggleManualControl() {
    const form = document.querySelector("form");
    form.style.display = form.style.display === "block" ? "none" : "block";
}

async function fetchRecipeContent(recipeName) {
    try {
        const response = await fetch(`/get_recipe_content?name=${encodeURIComponent(recipeName)}`);
        if (!response.ok) {
            throw new Error(`Fehler beim Laden des Rezepts: ${response.statusText}`);
        }

        const recipeContent = await response.text();
        if (!recipeContent.trim()) {
            showSnackbar(`Das Rezept '${recipeName}' ist leer.`, "error");
            return;
        }

        analyzeRecipe(recipeName, recipeContent);
    } catch (error) {
        console.error(`Fehler beim Abrufen des Rezepts:`, error);
        showSnackbar(`Das Rezept '${recipeName}' konnte nicht geladen werden.`, "error");
    }
}

function analyzeRecipe(recipeName, recipeContent) {
    const modal = document.getElementById("drink-details-modal");
    const overlay = document.getElementById("modal-overlay");
    const detailsList = document.getElementById("recipe-details-list");

    if (!recipeContent.trim()) {
        showSnackbar(`Das Rezept '${recipeName}' enthält keine Inhalte.`, "error");
        return;
    }

    const lines = recipeContent.split(/\r?\n/);
    const ingredientAmounts = {};
    let currentIngredient = null;

    lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("move")) {
            currentIngredient = line.split(" ")[1];
        } else if (line.startsWith("servo cl") && currentIngredient) {
            const amount = parseFloat(line.split(" ")[2]);
            if (!ingredientAmounts[currentIngredient]) {
                ingredientAmounts[currentIngredient] = 0;
            }
            ingredientAmounts[currentIngredient] += amount;
        }
    });

    detailsList.innerHTML = "";
    if (Object.keys(ingredientAmounts).length === 0) {
        detailsList.innerHTML = "<li>Zutaten nicht verfügbar</li>";
    } else {
        for (const [ingredient, amount] of Object.entries(ingredientAmounts)) {
            const li = document.createElement("li");
            li.textContent = `${ingredient}: ${amount.toFixed(1)} cl`;
            detailsList.appendChild(li);
        }
    }

    modal.querySelector("h3").textContent = `Rezept für ${recipeName}`;
    modal.style.display = "block";
    overlay.style.display = "block";
}

function closeDrinkDetails() {
    const modal = document.getElementById("drink-details-modal");
    const overlay = document.getElementById("modal-overlay");
    modal.style.display = "none";
    overlay.style.display = "none";
}

async function fetchProgress() {
    try {
        const response = await fetch("/recipe_progress");
        const data = await response.json();
        const progress = data.progress;

        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        progressBar.style.width = progress + "%";
        progressText.textContent = `Fortschritt: ${progress}%`;

        if (progress >= 100) {
            clearInterval(progressInterval);
            alert("Rezept abgeschlossen!");
        }
    } catch (error) {
        console.error("Fehler beim Abrufen des Fortschritts:", error);
    }
}

function startProgressTracking() {
    document.getElementById("progress-container").style.display = "block";
    progressInterval = setInterval(fetchProgress, 1000);
}

function togglePumpOptions() {
    const commandType = document.getElementById("manualCommandType").value;
    const pumpOptions = document.getElementById("pumpOptions");
    if (commandType === "pump") {
        pumpOptions.style.display = "block";
    } else {
        pumpOptions.style.display = "none";
    }
}

/* Neue Funktionen für Custom-Konfiguration */

let currentRecipeForConfig = "";

async function openCustomConfig(recipeName) {
    currentRecipeForConfig = recipeName;
    try {
        const response = await fetch(`/get_recipe_ingredients?recipe=${encodeURIComponent(recipeName)}`);
        const result = await response.json();
        if (result.status === "success") {
            const ingredients = result.ingredients;
            currentCustomIngredients = ingredients;
            showCustomConfigModal(ingredients);
        } else {
            showSnackbar(result.message, "error");
        }
    } catch (error) {
        showSnackbar("Fehler beim Laden der Rezeptzutaten.", "error");
    }
}

function showCustomConfigModal(ingredients) {
    const overlay = document.getElementById("custom-config-overlay");
    const modal = document.getElementById("custom-config-modal");
    const ul = modal.querySelector("ul");
    ul.innerHTML = "";

    ingredients.forEach(ing => {
        const li = document.createElement("li");
        const label = document.createElement("label");
        label.textContent = `${ing.name}: `;
        const spanVal = document.createElement("span");
        spanVal.style.fontWeight = "normal";
        spanVal.textContent = `${ing.amount.toFixed(1)} cl`;

        const range = document.createElement("input");
        range.type = "range";
        range.min = "0";
        range.max = (ing.amount * 1.5).toFixed(1);
        range.step = "0.1";
        range.value = ing.amount.toFixed(1);

        range.addEventListener("input", () => {
            spanVal.textContent = `${range.value} cl`;
            ing.current = parseFloat(range.value);
        });

        li.appendChild(label);
        li.appendChild(range);
        li.appendChild(spanVal);

        ul.appendChild(li);
    });

    overlay.style.display = "block";
    modal.style.display = "block";
}

function closeCustomConfigModal() {
    const overlay = document.getElementById("custom-config-overlay");
    const modal = document.getElementById("custom-config-modal");
    overlay.style.display = "none";
    modal.style.display = "none";
    currentCustomIngredients = [];
    currentRecipeForConfig = "";
}

async function startCustomConfigRecipe() {
    // Sende angepasste Mengen an Server
    const data = {
        recipe: currentRecipeForConfig,
        ingredients: currentCustomIngredients.map(i => ({name:i.name, amount:i.current || i.amount}))
    };

    try {
        const response = await fetch("/run_custom_recipe", {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === "success") {
            showSnackbar(`Rezept '${currentRecipeForConfig}' mit angepassten Mengen gestartet!`, "success");
            startProgressTracking();
            closeCustomConfigModal();
        } else {
            showSnackbar(result.message, "error");
        }
    } catch (error) {
        showSnackbar("Fehler beim Starten des angepassten Rezepts.", "error");
    }
}

</script>
</head>
<body>
<header>
    <div class="header-container">
        <h1>Drinks Übersicht</h1>
        <div id="esp-status">
            {% if esp_connected %}
            <span class="status connected">
                <span class="indicator"></span> ESP verbunden
            </span>
            {% else %}
            <span class="status disconnected">
                <span class="indicator"></span> ESP nicht verbunden
            </span>
            {% endif %}
        </div>
    </div>
</header>

<main>

    <div id="progress-container">
        <p id="progress-text">Fortschritt: 0%</p>
        <div style="width: 100%; background-color: #ccc; border-radius: 10px;">
            <div id="progress-bar"></div>
        </div>
    </div>

    <nav>
        <button onclick="window.location.href='/rezepte'">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-text" viewBox="0 0 16 16">
  <path d="M5 8h6v1H5V8zM5 5h6v1H5V5z"/>
  <path d="M14 4h1V3h-1V2a2 2 0 0 0-2-2H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V9h1V8h-1V4z"/>
</svg>

            Rezepte verwalten
        </button>
        <button onclick="window.location.href='/config'">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
  <path d="M8 4a3 3 0 1 1 0 8 3 3 0 0 1 0-8z"/>
  <path d="M8 0a1 1 0 0 1 .993.883L9 1v1.05c.326.07.64.177.935.317l.708-.708A1 1 0 0 1 12.414.586l.708.708a1 1 0 0 1 0 1.414l-.708.708c.14.295.247.61.317.935H15a1 1 0 0 1 .993.883L16 6v1a1 1 0 0 1-.883.993L15 8h-1.05a5.022 5.022 0 0 1-.317.935l.708.708a1 1 0 0 1-1.414 1.414l-.708-.708c-.295.14-.61.247-.935.317V15a1 1 0 0 1-.883.993L8 16H7a1 1 0 0 1-.993-.883L6 15v-1.05a5.022 5.022 0 0 1-.935-.317l-.708.708a1 1 0 0 1-1.414-1.414l.708-.708A5.022 5.022 0 0 1 1.05 9H0a1 1 0 0 1-.993-.883L0 8V7a1 1 0 0 1 .883-.993L1 6h1.05c.07-.326.177-.64.317-.935l-.708-.708A1 1 0 0 1 2.586.586l.708.708c.295-.14.61-.247.935-.317V1a1 1 0 0 1 .883-.993L5 0h1h1z"/>
</svg>

            Konfiguration verwalten
        </button>
    </nav>

    <section class="config-section">
        <h2>Verfügbare Drinks</h2>
        <div class="grid-container">
            {% for recipe in recipes|sort(attribute='name') if recipe.valid %}
            <div class="grid-item valid">
                <div class="info-icon" onclick="fetchRecipeContent('{{ recipe.name }}')">?</div>
                <!-- Neue config-icon oben rechts -->
                <div class="config-icon" onclick="openCustomConfig('{{ recipe.name }}')">⚙</div>
                <div class="letter">{{ recipe.name[0] }}</div>
                <div class="name">{{ recipe.name.replace('.txt', '') }}</div>
                <button class="start-button" onclick="startRecipe('{{ recipe.name }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
  <path d="M11.596 8.697l-6.363 3.692A.75.75 0 0 1 4 11.692V4.308a.75.75 0 0 1 1.233-.604l6.363 3.692a.75.75 0 0 1 0 1.301z"/>
</svg>

                    Starten
                </button>
            </div>
            {% endfor %}
        </div>
    </section>

    <section class="config-section">
        <h2>Nicht verfügbare Drinks</h2>
        <div class="grid-container">
            {% for recipe in recipes|sort(attribute='name') if not recipe.valid %}
            <div class="grid-item invalid">
                <div class="info-icon" onclick="fetchRecipeContent('{{ recipe.name }}')">?</div>
                <div class="letter">{{ recipe.name[0] }}</div>
                <div class="name">{{ recipe.name.replace('.txt', '') }}</div>
                <button class="start-button" onclick="showInvalidReasons('{{ loop.index }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8c0-1.7-3.6-5.5-8-5.5S0 6.3 0 8s3.6 5.5 8 5.5S16 9.7 16 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z"/>
</svg>

                    Details anzeigen
                </button>
                <div id="reasons-{{ loop.index }}" style="display:none;">
                    {% for reason in recipe.reasons %}
                        {{ reason }}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <div id="modal-overlay" class="modal-overlay" onclick="closeDrinkDetails()"></div>
    <div id="drink-details-modal" class="modal">
        <h3>Rezept Zutaten</h3>
        <ul id="recipe-details-list"></ul>
        <button class="close-button" onclick="closeDrinkDetails()">Schließen</button>
    </div>

    <div class="toggle-manual">
        <button onclick="toggleManualControl()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tools" viewBox="0 0 16 16">
  <path d="M1 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V1a.5.5 0 0 1-.5.5H14v1h.5a.5.5 0 0 1 0 1H14v1h.5a.5.5 0 0 1 0 1H14v1h.5a.5.5 0 0 1 0 1H14v1h.5a.5.5 0 0 1 0 1H14v.5a.5.5 0 0 1-1 0V15h-1v.5a.5.5 0 0 1-1 0V15h-1v.5a.5.5 0 0 1-1 0V15h-1v.5a.5.5 0 0 1-1 0V15H4v.5a.5.5 0 0 1-1 0V15H2v.5a.5.5 0 0 1-1 0V15H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1 0-1H1V11H.5a.5.5 0 0 1 0-1H1V9H.5a.5.5 0 0 1 0-1H1V7H.5a.5.5 0 0 1 0-1H1V5H.5a.5.5 0 0 1 0-1H1V3H.5A.5.5 0 0 1 0 2.5V2a.5.5 0 0 1 .5-.5h0z"/>
</svg>

            Manuelle Steuerung anzeigen/ausblenden
        </button>
    </div>

    <form onsubmit="event.preventDefault(); sendManualCommand();">
        <label for="manualCommandType">Befehlstyp:</label>
        <select id="manualCommandType" name="manualCommandType" onchange="togglePumpOptions()" required>
            <option value="move">Plattform bewegen (mm)</option>
            <option value="servo">Servo bewegen (ms)</option>
            <option value="pump">Pumpe aktivieren (ms)</option>
        </select>
        <div id="pumpOptions" style="display: none;">
            <label for="pumpNumber">Pumpe:</label>
            <select id="pumpNumber" name="pumpNumber" required>
                <option value="1">Pumpe 1</option>
                <option value="2">Pumpe 2</option>
                <option value="3">Pumpe 3</option>
                <option value="4">Pumpe 4</option>
            </select>
        </div>
        <label for="manualValue">Wert:</label>
        <input type="number" id="manualValue" name="manualValue" placeholder="Wert eingeben..." required>
        <button type="submit">Befehl senden</button>
    </form>

    <!-- Custom Config Modal -->
    <div id="custom-config-overlay" style="display:none;"></div>
    <div id="custom-config-modal">
        <h3>Konfiguration anpassen</h3>
        <ul></ul>
        <div id="custom-config-modal-buttons">
            <button id="custom-config-modal-cancel" onclick="closeCustomConfigModal()">Abbrechen</button>
            <button id="custom-config-modal-start" onclick="startCustomConfigRecipe()">Starten</button>
        </div>
    </div>

</main>

<footer>
    &copy; 2024 Leo Fleischmann
</footer>

<div id="snackbar" class="snackbar"></div>

</body>
</html>
